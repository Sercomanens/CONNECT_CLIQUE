<div class="container mt-4" data-controller="toggle-form">
  <div class="show-activity-card">
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="show-activity-title"><%= @activity.name %></h2>
      <div class="dropdown">
        <img src="<%= asset_path('three_dots.png') %>" alt="Options" class="three-dots-icon" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
          <% if policy(@activity).edit? %>
            <li><%= link_to 'Edit', edit_activity_path(@activity), class: 'dropdown-item' %></li>
          <% end %>
          <li><%= link_to 'Back', activities_path, class: 'dropdown-item' %></li>
          <% if policy(@activity).destroy? %>
            <li><%= link_to 'Delete', activity_path(@activity), data: { turbo_method: :delete, turbo_confirm: 'Are you sure?' }, class: 'dropdown-item' %></li>
          <% end %>
        </ul>
      </div>
    </div>

    <!-- Display photos -->
    <div id="carouselExample" class="carousel slide carousel-container" data-bs-ride="carousel">
      <div class="carousel-inner">
        <% @activity.photos.each_with_index do |photo, index| %>
          <div class="carousel-item <%= 'active' if index == 0 %>">
            <%= cl_image_tag photo.key, height: 200, width: 300, crop: :pad, class: 'd-block w-100 modern-photo' %>
          </div>
        <% end %>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>

    <!-- Description -->
    <p class="show-activity-detail mb-4"><%= @activity.description %></p>

    <% if @activity.voting_closed %>
      <p class="show-activity-detail">
        <strong>Date of Activity:</strong>
        <span class="text-success"><%= @activity.winning_date %> âœ…</span>
      </p>
      <% if @activity.start_time.present? && @activity.end_time.present? %>
        <p class="show-activity-detail">
          <strong>Time of Activity:</strong>
          <%= @activity.start_time.strftime("%H:%M %p") %> - <%= @activity.end_time.strftime("%H:%M %p") %>
        </p>
      <% end %>
    <% end %>

    <!-- Edit and Vote links -->
    <div class="btn-container">
      <% if current_user == @activity.user && !@activity.voting_closed %>
        <% if !current_user.votes.exists?(activity: @activity) %>
          <button data-action="click->toggle-form#fire" class="btn2 vote-button">Vote</button>
        <% end %>
        <%= button_to 'Close Vote', close_voting_activity_path(@activity), method: :post, class: 'btn2' %>
      <% end %>
    </div>

    <!-- Voting options (hidden by default) -->
    <div data-toggle-form-target="togglableElement" class="d-none py-4 px-3 rounded">
      <%= form_with(model: [@activity, @vote], local: false, id: 'vote-form') do |f| %>
        <div class="form-check">
          <%= f.radio_button :selected_date, @activity.date_1, class: 'form-check-input' %>
          <%= f.label :selected_date, @activity.date_1, value: @activity.date_1, class: 'form-check-label' %>
        </div>
        <div class="form-check">
          <%= f.radio_button :selected_date, @activity.date_2, class: 'form-check-input' %>
          <%= f.label :selected_date, @activity.date_2, value: @activity.date_2, class: 'form-check-label' %>
        </div>
        <div class="form-check">
          <%= f.radio_button :selected_date, @activity.date_3, class: 'form-check-input' %>
          <%= f.label :selected_date, @activity.date_3, value: @activity.date_3, class: 'form-check-label' %>
        </div>
        <%= f.submit 'Submit Vote', class: 'btn1 mt-2' %>
      <% end %>
    </div>

    <!-- Message display area -->
    <div id="message-display" class="mt-3"></div>
  </div>

  <!-- Map display -->
  <div id="map" class="map-container"
       data-controller="map"
       data-map-markers-value="<%= @markers.to_json %>"
       data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>"></div>

  <!-- Attendees Avatars -->
  <div class="attendees-container mt-4">
    <h3 class="show-activity-title">Attendees</h3>
    <div class="avatars">
      <% @attendees.each do |attendance| %>
        <div class="avatar">
          <%= image_tag attendance.user.avatar_url, alt: attendance.user.name, class: 'avatar-image' %>
          <p class="avatar-name"><%= attendance.user.name %></p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('turbo:load', () => {
  const form = document.getElementById('vote-form');
  const messageDisplay = document.getElementById('message-display');

  if (form) {
    form.addEventListener('submit', function(event) {
      event.preventDefault();

      fetch(this.action, {
        method: 'POST',
        body: new FormData(this),
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Turbo-Frame': 'message-display'
        }
      })
      .then(response => response.text())
      .then(data => {
        messageDisplay.innerHTML = data;
      })
      .catch(error => console.error('Error:', error));
    });
  }
});
</script>
